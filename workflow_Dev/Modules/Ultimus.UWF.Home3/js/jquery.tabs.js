EM={};EM.recycler=(function(){var A=document.createElement("div");A.id="recycler";return A})();EM.destroyElement=function(A){A=typeof(A)==="string"?document.getElementById(A):A;if(A.hasChildNodes()){EM.destroyElement(A.firstChild);EM.destroyElement(A)}if(A.tagName==="IFRAME"){$(A).unbind();A.src="about:blank";menutab=document.getElementById("menuTask");if(menutab!=null){if(menutab.childNodes.length==0){info=document.getElementById("divInfo");if(info!=null){info.style.display=""}}}}if(A&&EM.recycler){$(A).unbind();try{EM.recycler.appendChild(A)}catch(B){return}EM.recycler.innerHTML=""}if($.browser.msie){CollectGarbage()}};EM.Events=function(B){var C=B;var A=[];return{addEvents:function(){for(var D=0;D<arguments.length;D++){if(this.indexOfEvent(arguments[D])<0){A.push({name:arguments[D],handlers:null})}}},addEventHandler:function(F,D){var E=this.indexOfEvent(F);if(E>-1){if(!A[E].handlers){A[E].handlers=[]}A[E].handlers.push(D)}},trigger:function(E){var D=this.indexOfEvent(E);if(D>-1){if(!A[D].handlers){return}for(var F=0;F<A[D].handlers.length;F++){A[D].handlers[F].apply(C,Array.prototype.slice.call(arguments,1))}}},removeEvents:function(){for(var E=0;E<arguments.length;E++){var D=this.indexOfEvent(arguments[E]);if(D>-1){A[D]=null;A.splice(D,1)}}},indexOfEvent:function(D){for(var E=0;E<A.length;E++){if(A[E].name===D){return E}}return -1}}};EM.ui=EM.ui||{};EM.ui.tabs=function(A){this._init(A)};$.extend(EM.ui.tabs.prototype,{_init:function(F){this.options=$.extend({el:null,closable:false,refresh:false,width:"100%",height:"100%",headerWidth:"auto",tabPosition:"top",handlers:null,isButton:false,isButtonWidth:null,selectedIndex:0,headerTemplate:'<a href="#{href}"><span>#{text}</span></a><a class="em-tab-refresh"><span class="em-tab-refresh-#{refresh}"></span></a><a class="em-tab-close"><span class="em-tab-closable-#{closable}"></span></a>',frameTemplate:'<div id="#{id}"><iframe url="#{url}" id="iframe-#{id}" name="iframe-#{id}"  scrolling="auto" src="" frameborder="0" style="width: 100%;height: 100%; visibility: inherit;display: inherit;"></iframe></div>'},F);if(typeof this.options.el!="object"&&typeof this.options.el!="string"){alert("初始化对象为空或不存在");return}this.events=new EM.Events(this);this.events.addEvents("tabadd","tabremove","tabchange","tabbeforeload","tabshow","tabcontextmenu","tabload");if(this.options.handlers){for(var D=0,C=this.options.handlers.length;D<C;D++){this.events.addEventHandler(this.options.handlers[D].name,this.options.handlers[D].fn)}}this.items=EM.ui.tabs.ItemStack();this.stack=EM.ui.tabs.AccessStack();this.frameCount=0;this.body=$(this.options.el).addClass("em-tab-panel").width(this.options.width);this.strip=this.body.find("ul:first").addClass("em-tab-strip").wrap('<div class="em-tab-panel-header"></div>').wrap('<div class="em-tab-strip-wrap"></div>');this.stripWrap=this.strip.parent();this.header=this.stripWrap.parent();this.scrollLeft=$('<div  class="em-tab-scroller-left"></div>').prependTo(this.header).hide();this.scrollRight=$('<div  class="em-tab-scroller-right"></div>').prependTo(this.header).hide();this.scrollable=false;var E=this.strip.find("li");for(var D=0,A=E.length;D<A;D++){var B=$(E[D]).find("a");$(E[D]).html(this.options.headerTemplate.replace(/#\{text\}/g,B.text()).replace(/#\{closable\}/g,$(E[D]).attr("closable")||this.options.closable)).children("a:first").attr("href",B.attr("href"));EM.destroyElement(B.get(0));this._addTab(E[D])}E=null;this.select(this.options.selectedIndex)},add:function(K,D,Q,T,I,G){Q=typeof Q==="string"?Q:null;var S=$("#em_tab_li_"+Q);$(".navBarL b").html("当前位置："+G);$(".navBarNav ul li").each(function(){if(this.id!="liMenu"+Q){$(this).removeClass("current")}else{$(this).addClass("current")}});if(S.length>0){for(var B=0,O=this.getTabCount();B<O;B++){if(this.getTab(B).header===S.get(0)){this.select(B);var P=this.getSelectedTab();var J=$(P.content).find("iframe");var M=J.contents();if(I!=null){var E=M.find("#hdUrl");if(E!=null){E.val(I);M.find("#btnAddModel").trigger("click");break}}J.attr("src",D);break}}}else{D=typeof D==="string"?D:"#"+$(D).attr("id");if(Q){S=$('<li id="em_tab_li_'+Q+'" title="'+G+'">'+this.options.headerTemplate.replace(/#\{text\}/g,K).replace(/#\{closable\}/g,T?T:this.options.closable)+"</li>").appendTo(this.strip)}else{S=$("<li>"+this.options.headerTemplate.replace(/#\{text\}/g,K).replace(/#\{closable\}/g,T?T:this.options.closable)+"</li>").appendTo(this.strip)}rn=+Math.random()*1000;D=D.indexOf("?")>=0?D+"&"+rn:D+"?&"+rn;S.find("a:first").attr("href",D);this._addTab(S.get(0));if(this.getHeadersWidth()>this.stripWrap.width()&&!this.scrollable){this._showScrollers()}if(this.scrollable&&this.scrollerLimite!=this.getHeadersWidth()){this.updateScrollers()}this.select(this.getTabCount()-1);this.events.trigger("tabadd",this.getSelectedTab())}S=null;Q=null;$(window).resize()},select:function(B,C){if(B<0||B>=this.getTabCount()){return}if(B!=this.getSelectedIndex()){this.stack.add(this.getSelectedTab())}if(C!=null){$(".navBarL b").html("当前位置："+$(C).attr("title"));var F=C.id.replace("em_tab_li_menu","").split("_");if(F.length==2){window.parent.OpenApp(null,F[1])}$(".navBarNav ul li").each(function(){$(this).removeClass("current")});$(C).addClass("current")}var E=this.getSelectedTab();E?this._hideTab(E):null;this.options.selectedIndex=B;var D=this.getSelectedTab();this._showTab(D);var A=$(D.content).find("iframe");if(D.type==="url"&&A.attr("src")===""){this.events.trigger("tabbeforeload",D);A.bind("load",{obj:this.events,args:D},function(G){G.data.obj.trigger("tabload",G.data.args)});A.attr("src",A.attr("url"))}if(this.scrollable){this.scrollToTab(B)}this.events.trigger("tabchange",D,E);E=A=null;info=document.getElementById("divInfo");if(info!=null){info.style.display="none"}return D},scrollToTab:function(D){var E=this.getHeadersWidth(D-1);var F=E+$(this.items.get(D).header).outerWidth();var G=parseInt(this.strip.css("left"));if(F+G>this.stripWrap.width()){this.strip.animate({left:this.stripWrap.width()-F},1000)}else{if(E+G<=0){this.getHeadersWidth()-this.getHeadersWidth(D-1)<this.stripWrap.width()?this.strip.animate({left:this.stripWrap.width()-this.getHeadersWidth()},1000):this.strip.animate({left:-E},1000)}else{if(this.getHeadersWidth()+parseInt(this.strip.css("left"))<this.stripWrap.width()){this.strip.animate({left:this.stripWrap.width()-this.getHeadersWidth()},1000)}}}E=F=G=null},remove:function(A,B){var D=this.getTab(A);if(!D){return}var E=null;if(B!=null){E=B.parentNode.parentNode.parentNode}this._removeTab(D);if(this.getHeadersWidth()<this.stripWrap.width()&&this.scrollable){this._hideScrollers()}if(this.scrollable){this.updateScrollers()}var C=false;if(A<this.getSelectedIndex()){this.options.selectedIndex--}else{if(A===this.getSelectedIndex()){C=this.getIndex(this.stack.next())}}if(typeof C==="number"){this.select(C<0?this.getTabCount()-1:C,$(E).find("li").get(C))}else{this.scrollable?this.scrollToTab(this.getSelectedIndex()):null}D=C=null;this.events.trigger("tabremove")},removeTab:function(B){B=typeof B==="string"?B:null;if(!B){return}var A=$("#em_tab_li_"+B);if(A.length>0){lt=this.getTabCount();for(var D=0,C=lt;D<C;D++){if(this.getTab(D).header===A.get(0)){this.remove(D);break}}lt=null}A=null},removeAll:function(){var A=this.getTabCount();for(i=0;i<A;i++){this.remove(0)}A=null},removeCurrent:function(){this.remove(this.getSelectedIndex())},updateScrollers:function(){this.scrollerLimite=this.getHeadersWidth();this.scrollLeft.unbind().bind("mousedown",{offset:"0",strip:this.strip},this._scrolling).bind("mouseup",{strip:this.strip},this._stopScrolling);this.scrollRight.unbind().bind("mousedown",{offset:this.stripWrap.width()-this.scrollerLimite,strip:this.strip},this._scrolling).bind("mouseup",{strip:this.strip},this._stopScrolling)},refresh:function(B){var C=this.getTab(B);var A=$(C.content).find("iframe");A.attr("src",A.attr("src"))},contextmenu:function(A){this.events.trigger("contextmenu",this.getTab(A))},getTab:function(A){return this.items.get(A)},getSelectedTab:function(){return this.getSelectedIndex()<this.getTabCount()&&this.getSelectedIndex()>=0?this.getTab(this.getSelectedIndex()):null},getTabCount:function(){return this.items.getCount()},getBody:function(){return this.body.get(0)},getSelectedIndex:function(){return this.options.selectedIndex},getIndex:function(A){for(var E=0,D=this.getTabCount();E<D;E++){if(this.getTab(E)===A){return E}}return -1},getContentHeight:function(){var D=0;var B=this.body.children("div:visible:not(.em-tab-content-selected)");for(var C=0,A=B.length;C<A;C++){D+=$(B[C]).height()}B=null;return this.body.height()-D},getHeadersWidth:function(B){B=typeof B==="number"?B:this.items.getCount()-1;var A=parseInt(this.strip.css("padding-left"));for(var C=0;C<=B;C++){A+=$(this.items.get(C).header).outerWidth(true)}return A},_addTab:function(C){$(C).find("a:first").width(this.options.headerWidth);var B=$(C).find("a:first");var A=this._getTabType(B);this.items.add(this._createItem(C,this._getTabContent(B),A));$(C).find("a:first").unbind("click").bind("click",{"obj":this,"action":"select"},this._headerEventHander);$(C).unbind("contextmenu").bind("contextmenu",{"obj":this,"action":"contextmenu"},this._headerEventHander);$(C).find(".em-tab-close span").unbind("click").bind("click",{"obj":this,"action":"remove"},this._headerEventHander);$(C).find(".em-tab-refresh span").unbind("click").bind("click",{"obj":this,"action":"refresh"},this._headerEventHander);B=C=A=null},_removeTab:function(A){EM.destroyElement(A.header);EM.destroyElement(A.content);if(A.type==="url"){this.frameCount--}this.stack.remove(A);this.items.remove(A)},_createItem:function(B,A,D){return{"header":B,"content":A,"type":(D!="url"?"div":D)}},_hideTab:function(A){$(A.header).removeClass("em-tab-selected");$(A.content).removeClass("em-tab-content-selected").addClass("em-tab-content");A=null},_showTab:function(A){$(A.header).addClass("em-tab-selected");$(A.content).addClass("em-tab-content-selected").removeClass("em-tab-content");this.events.trigger("tabshow",A);A=null},_getTabContent:function(C){var D=null,B=null;if(this._getTabType(C)==="div"){D=$(C.attr("href")).addClass("em-tab-content")}else{if(this.options.tabPosition=="top"){D=$(this.options.frameTemplate.replace(/#\{url\}/g,C.attr("href")).replace(/#\{id\}/g,C.attr("href")+"-"+this.frameCount++)).appendTo(this.body).addClass("em-tab-content")}else{if(this.options.tabPosition=="bottom"){D=$(this.options.frameTemplate.replace(/#\{url\}/g,C.attr("href")).replace(/#\{id\}/g,C.attr("href")+"-"+this.frameCount++)).prependTo(this.body).addClass("em-tab-content")}}C.attr("href","#"+C.attr("href"))}C=preHeight=B=null;D.height(this.getContentHeight());return D.get(0)},_getTabType:function(A){if(A.attr("href").substring(0,1)==="#"){return"div"}return"url"},_headerEventHander:function(E){E.preventDefault();var A=$(this).parents("li:eq(0)").get(0);var B=E.data.obj;for(var D=0,C=B.getTabCount();D<C;D++){if(B.getTab(D).header===A){if(E.data.action==="select"){D===B.getSelectedIndex()?null:B[E.data.action](D,this.parentNode);this.blur()}else{B[E.data.action](D,this.parentNode)}break}}A=B=null},_showScrollers:function(){var A=this.options.tabPosition?this.options.isButtonWidth:0;this.scrollLeft.show();this.scrollRight.show();this.stripWrap.css("margin-left",this.scrollLeft.width()+A).css("margin-right",this.scrollRight.width()).width(this.stripWrap.width()-this.scrollLeft.width()-this.scrollRight.width()-A);this.updateScrollers();this.scrollable=true},_hideScrollers:function(){this.strip.css("left","0px");this.scrollLeft.hide().unbind();this.scrollRight.hide().unbind();this.stripWrap.css("margin-left","0").css("margin-right","0").width(this.stripWrap.width()+this.scrollLeft.width()+this.scrollRight.width());this.scrollable=false},_scrolling:function(A){A.preventDefault();A.data.strip.animate({left:A.data.offset},"slow")},_stopScrolling:function(A){A.preventDefault();A.data.strip.stop()}});EM.ui.tabs.ItemStack=function(){var B=[];return{get:function(A){return B[A]},add:function(A){B.push(A)},remove:function(H){if(typeof H==="number"){B.splice(H,1);return}var G=[];for(var F=0,A=B.length;F<A;F++){if(B[F]!=H){G.push(B[F])}}B=G;G=null},getCount:function(){return B.length}}};EM.ui.tabs.AccessStack=function(){var B=[];return{add:function(A){B.push(A);if(B.length>10){B.shift()}},remove:function(H){var G=[];for(var F=0,A=B.length;F<A;F++){if(B[F]!=H){G.push(B[F])}}B=G},next:function(){return B.pop()}}};